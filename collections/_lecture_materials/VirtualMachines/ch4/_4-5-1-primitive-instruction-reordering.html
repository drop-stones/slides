<div class="subsection" id="vm-4-5-1-primitive-instruction-reordering">
  <h3>4.5.1 Primitive Instruction Reordering</h3>

  <p>
    In this subsection, we consider reordering pairs of instructions (swapping one for another).<br />
    We discuss in the following steps:
  </p>
  <ol>
    <li>
      Categorize the instructions into four categries.
      <ul>
        <li>reg: Register updates</li>
        <li>mem: Memory updates</li>
        <li>br: Branch instructions</li>
        <li>join: Join points</li>
      </ul>
    </li>
    <li>
      Discuss possible reordering.
      <ul>
        <li>br &#8646; another</li>
        <li>join &#8646; another</li>
        <li>remaining pairs</li>
      </ul>
    </li>
  </ol>

  <div class="subsubsection" id="vm-four-instruction-categories">
    <h4>Four instruction categories</h4>

    <ul>
      <li>
        reg: Register updates
        <ul>
          <li>Description: instructions that produce a register result</li>
          <li>Property: can be "undone" (using saved registers, saving into memory)</li>
          <li>
            Examples:
            <ul>
              <li>{% highlight c %}mov rax, [rbx] // rax = mem[rbx]{% endhighlight %}</li>
              <li>{% highlight c %}add r1, r2, r3 // r1 = r2 + r3{% endhighlight %}</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        mem: Memory updates
        <ul>
          <li>Description: instructions that place a value in a memory</li>
          <li>Property: cannot be "undone" easily (because saving memory have high cost of time and memory)</li>
          <li>
            Examples:
            <ul>
              <li>{% highlight c %}mov [rax], rbx // mem[rax] = rbx{% endhighlight %}</li>
              <li>{% highlight c %}stw r1, 4(r2) // mem[r2 + 4] = r1{% endhighlight %}</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        br: Branch instructions
        <ul>
          <li>Property: do not trap</li>
          <li>Example: {% highlight c %}bz label // if zero_flag == 0 then br label{% endhighlight %}</li>
        </ul>
      </li>

      <li>
        join: Join points
        <ul>
          <li>Description: the points where a jump or branch target enters the code sequence</li>
          <li>
            Property:
            <em>join</em>
            are not instructions but can affect reordering
          </li>
          <li>Example: {% highlight c %}{{ join-example }}{% endhighlight %}</li>
        </ul>
      </li>
    </ul>

    <p>
      In addition,
      <em>volatile memory access</em>
      is categorized as mem.
    </p>

    <ul>
      <li>
        Access to
        <em>volatile memory locations</em>
        <ul>
          <li>
            A
            <em>volatile memory location</em>
            may be accessed by an entity other than the process.
            <ul>
              <li>Shared memory with other process or thread</li>
              <li>Memory-mapped I/O with I/O system</li>
            </ul>
          </li>
          <li>
            Property: cannot be reordered in many cases:
            <ul>
              <li>We cannot move an access to shared memory before getting lock (mutex).</li>
              <li>An access to memory-mapped I/O may trigger some I/O device functions.</li>
            </ul>
          </li>
          <li>Category: mem (because state cannot be recovered easily)</li>
        </ul>
      </li>
    </ul>

    <p>
      In some VM applications, the emulation system must optimize conservatively because it does not know whether the memory access is
      <em>volatile</em>
      or not.
    </p>

    <div class="example" id="vm-example-four-instruction-categories">
      <h5>Four instruction categories</h5>
      <div class="flex-container">
        <div>{% highlight c %}{{ ins-categories }}{% endhighlight %}</div>
      </div>
    </div>
    <!-- vm-example-four-instruction-categories -->
  </div>
  <!-- vm-four-instruction-categories -->

  <p>
    We will now discuss the reordering of two adjacent instructions.<br>
    There are two keys to understanding well:
  </p>
  <ul>
    <li>
      Are memory and register states recoverable at trap instructions?
      <ul>
        <li>If so, the reordering is allowed.</li>
        <li>If not, the reordering is not allowed.</li>
      </ul>
    </li>
    <li>
      Does the reordering change control flow?
      <ul>
        <li>If so, the reordering is not allowed.</li>
        <li>If not, the reordering is allowed.</li>
      </ul>
    </li>
  </ul>

  <div class="subsubsection" id="vm-br-another">
    <h4>br &#8646; another</h4>

    <div class="paragraph" id="vm-move-reg-or-mem-below-br">
      <h5>Move reg or mem below br</h5>
      <div class="flex-container">
        <div class="width-half"><img src="{{ img_path }}/move-reg-below-br.svg"></div>
        <div class="width-half"><img src="{{ img_path }}/move-mem-below-br.svg"></div>
      </div>

      <p>We can move reg or mem below br because:</p>
      <ul>
        <li>The moved instruction is executed both under <em>branch-taken</em> and <em>branch-not-taken</em>.</li>
        <li>Not change control flow.</li>
      </ul>

      <div class="example" id="vm-example-move-reg-below-br">
        <h5>Move reg below br</h5>

        <div class="code-title"><p>Before reordering</p></div>
        <div class="flex-container">
          <div>{% highlight c %}{{ move-reg-below-br-before }}{% endhighlight %}</div>
          <div>{% highlight c %}{{ move-reg-below-br-exit-before }}{% endhighlight %}</div>
        </div>
        <div class="code-title"><p>After reordering</p></div>
        <div class="flex-container">
          <div>{% highlight c %}{{ move-reg-below-br-after }}{% endhighlight %}</div>
          <div>
            <div>
              <div class="code-title">Compensation Code</div>
              <div>{% highlight c %}{{ move-reg-below-br-compensation }}{% endhighlight %}</div>
            </div>
            <div>{% highlight c %}{{ move-reg-below-br-exit-after }}{% endhighlight %}</div>
          </div>
        </div>
      </div>
      <!-- vm-example-move-reg-below-br -->

      <p>
        <em>Compensation code</em>
        ensures that the state is the same as original code.
      </p>
    </div>
    <!-- vm-move-reg-or-mem-below-br -->

    <div class="paragraph" id="vm-move-reg-above-br">
      <h5>Move reg above br</h5>

      <div class="flex-container">
        <div class="width-half"><img src="{{ img_path}}/move-reg-above-br.svg"></div>
      </div>

      <p>We can move reg above br because:</p>
      <ul>
        <li>The original register value of <code>R</code> is remained while the moved instruction is executed.</li>
        <li>Not change control flow.</li>
      </ul>

      <div class="example" id="vm-example-move-reg-above-br">
        <h5>Move reg above br</h5>
        <div class="flex-container">
          <div>
            <div class="code-title">Before reordering</div>
            <div>{% highlight c %}{{ move-reg-above-br-before }}{% endhighlight %}</div>
          </div>
          <div>
            <div class="code-title">After reordering</div>
            <div>{% highlight c %}{{ move-reg-above-br-after }}{% endhighlight %}</div>
          </div>
          <div>
            <div class="code-title">Omit register copy</div>
            <div>{% highlight c %}{{ move-reg-above-br-no-update }}{% endhighlight %}</div>
          </div>
        </div>

        <p>There are two reasons why we insert saved register <code>T1</code>:</p>
        <ul>
          <li>
            <code>R6</code>
            must be
            <em>live</em>
            at label
            <code>exit</code>.
          </li>
          <li>
            <code>R6</code>
            must be
            <em>live</em>
            until the original position (between ins.2 and ins.4).
            <ul>
              <li><em>Live</em> means that the original values are hold.</li>
            </ul>
          </li>
        </ul>
      </div>
      <!-- vm-example-move-reg-above-reg -->
    </div>
    <!-- vm-move-reg-above-reg -->

    <div class="paragraph" id="vm-move-mem-above-br">
      <h5>Move mem above br</h5>
      <div class="flex-container">
        <div><img src="{{ img_path }}/move-mem-above-br.svg"></div>
      </div>

      <p>We cannot move mem above br because:</p>
      <ul>
        <li>
          The moved instruction is executed both under <em>branch-taken</em> and <em>branch-not-taken</em>.
          <ul>
            <li>Originally, the instruction is executed only under <em>branch-not-taken</em>.</li>
          </ul>
        </li>
        <li>Memory state cannot be saved. (or need extra instructions)</li>
      </ul>

      <div class="example" id="vm-example-move-mem-above-br">
        <h5>Move mem above br</h5>

        <div class="code-title"><p>Before reordering</p></div>
        <div class="flex-container">
          <div>{% highlight c %}{{ move-mem-above-br-before }}{% endhighlight %}</div>
          <div>{% highlight c %}{{ move-mem-above-br-exit-before }}{% endhighlight %}</div>
        </div>
        <div class="code-title"><p>After reordering</p></div>
        <div class="flex-container">
          <div>{% highlight c %}{{ move-mem-above-br-after }}{% endhighlight %}</div>
          <div>{% highlight c %}{{ move-mem-above-br-exit-after }}{% endhighlight %}</div>
        </div>

        <p>
          This example shows that
          <code>mem[R1]</code>
          cannot be recoverable.<br />
        </p>

        <div class="code-title"><p>Memory compatible but slow(?) reordering</p></div>
        <div class="flex-container">
          <div>{% highlight c %}{{ meaningless-move-mem }}{% endhighlight %}</div>
          <div>
            <div>{% highlight c %}{{ meaningless-move-mem-compensation }}{% endhighlight %}</div>
            <div>{% highlight c %}{{ meaningless-move-mem-exit }}{% endhighlight %}</div>
          </div>
        </div>

        <p>
          This reordering looks good, but an extra memory access is added.<br />
          From this, we assume that mem cannot be recoverable ("undone").
        </p>
      </div>
      <!-- vm-example-move-mem-above-br -->
    </div>
    <!-- vm-move-mem-above-br -->

    <div class="paragraph" id="vm-move-br-around-join">
      <h5>Move br above/below join</h5>
      <div class="flex-container">
        <div><img src="{{ img_path }}/move-br-above-join.svg"></div>
        <div><img src="{{ img_path }}/move-br-below-join.svg"></div>
      </div>

      <p>We cannot move br above/below join because:</p>
      <ul>
        <li>Change control flow.</li>
      </ul>

      <div class="example" id="vm-example-move-br-around-join">
        <h5>Move br above join</h5>
        <div class="flex-container">
          <div>
            <div class="code-title">Before reordering</div>
            <div>{% highlight c %}{{ move-br-around-join-branch-from }}{% endhighlight %}</div>
            <div>{% highlight c %}{{ move-br-around-join-before }}{% endhighlight %}</div>
          </div>
          <div>
            <div class="code-title">After reordering</div>
            <div>{% highlight c %}{{ move-br-around-join-branch-from }}{% endhighlight %}</div>
            <div>{% highlight c %}{{ move-br-around-join-after }}{% endhighlight %}</div>
          </div>
        </div>

        <p>This example shows that moving br around join changes control flow.</p>
      </div>
      <!-- vm-example-move-br-around-join -->
    </div>
    <!-- vm-move-br-around-join -->

    <div class="paragraph" id="vm-swap-br-and-br">
      <h5>Swap br and br</h5>
      <div class="flex-container">
        <div><img src="{{ img_path }}/swap-br-and-br.svg"></div>
      </div>

      <p>We cannot swap br and br because:</p>
      <ul>
        <li>Change control flow.</li>
      </ul>

      <div class="example" id="vm-example-swap-br-and-br">
        <h5></h5>
        <div class="flex-container">
          <div>
            <div class="code-title">Before optimization</div>
            <div>{% highlight c %}{{ swap-br-before }}{% endhighlight %}</div>
          </div>
          
          <div>
            <div class="code-title">After optimization</div>
            <div>{% highlight c %}{{ swap-br-after }}{% endhighlight %}</div>
          </div>
        </div>

        <p>Obviously control flow is changed.</p>
      </div>
      <!-- vm-example-move-br-and-br -->
    </div>
    <!-- vm-swap-br-and-br -->
  </div>
  <!-- vm-br-another -->

  <div class="subsubsection" id="vm-join-another">
    <h4>join &#8646; another</h4>

    <div class="paragraph" id="vm-move-reg-mem-above-join">
      <h5>Move reg/mem above join</h5>
      <div class="flex-container">
        <div class="width-half"><img src="{{ img_path }}/move-reg-above-join.svg"></div>
        <div class="width-half"><img src="{{ img_path }}/move-mem-above-join.svg"></div>
      </div>

      <p>We can move reg/mem above join because:</p>
      <ul>
        <li>The moved instruction is executed in all paths (by inserting compensation code).</li>
        <li>Not change control flow.</li>
      </ul>

      <div class="example" id="vm-example-move-reg-above-join">
        <h5>Move reg above join</h5>
        <div class="flex-container">
          <div>
            <div class="code-title">Before reordering</div>
            <div>{% highlight c %}{{ move-reg-above-join-branch-from }}{% endhighlight %}</div>
            <div>{% highlight c %}{{ move-reg-above-join-before }}{% endhighlight %}</div>
          </div>
          <div>
            <div class="code-title">After reordering</div>
            <div>{% highlight c %}{{ move-reg-above-join-branch-from-after }}{% endhighlight %}</div>
            <div>{% highlight c %}{{ move-reg-above-join-compensation }}{% endhighlight %}</div>
            <div>{% highlight c %}{{ move-reg-above-join-after }}{% endhighlight %}</div>
          </div>
        </div>

        <p>This reordering alone is meaningless, but this enable more optimizations.</p>
      </div>
      <!-- vm-example-reg-above-join -->
    </div>
    <!-- vm-move-reg-mem-above-join -->

    <div class="paragraph" id="vm-move-reg-or-mem-below-join">
      <h5>Move reg or mem below join</h5>
      <div class="flex-container">
        <div><img src="{{ img_path }}/move-reg-below-join.svg"></div>
        <div><img src="{{ img_path }}/move-mem-below-join.svg"></div>
      </div>

      <div class="example" id="vm-example-move-reg-below-join">
        <h5>Move reg below join</h5>
        <div class="flex-container">
          <div>
            <div class="code-title">Before reordering</div>
            <div>{% highlight c %}{{ move-reg-below-join-branch-from }}{% endhighlight %}</div>
            <div>{% highlight c %}{{ move-reg-below-join-before }}{% endhighlight %}</div>
          </div>
          <div>
            <div class="code-title">After reordering</div>
            <div>{% highlight c %}{{ move-reg-below-join-branch-from }}{% endhighlight %}</div>
            <div>{% highlight c %}{{ move-reg-below-join-after }}{% endhighlight %}</div>
          </div>
        </div>

        <p>
          This example shows that execution path 2-4-3 changes
          <code>R1</code>
          value.
        </p>
      </div>
      <!-- vm-example-move-reg-below-join -->
    </div>
    <!-- vm-move-reg-or-mem-below-join -->

    <div class="paragraph" id="vm-swap-join-points">
      <h5>Swap join points</h5>
      <div class="flex-container">
        <div><img src="{{ img_path }}/swap-join-and-join.svg"></div>
      </div>

      <div class="example" id="vm-example-swap-join-points">
        <h5>Swap join points</h5>
        <div class="flex-container">
          <div>
            <div class="code-title">Before reordering</div>
            <div>{% highlight c %}{{ swap-join-points-branch-label1 }}{% endhighlight %}</div>
            <div>{% highlight c %}{{ swap-join-points-branch-label2 }}{% endhighlight %}</div>
            <div>{% highlight c %}{{ swap-join-points-before }}{% endhighlight %}</div>
          </div>
          <div>
            <div class="code-title">After reordering</div>
            <div>{% highlight c %}{{ swap-join-points-branch-label1 }}{% endhighlight %}</div>
            <div>{% highlight c %}{{ swap-join-points-branch-label2 }}{% endhighlight %}</div>
            <div>{% highlight c %}{{ swap-join-points-after }}{% endhighlight %}</div>
          </div>
        </div>

        <p>This reordering have no effect cleary.</p>
      </div>
      <!-- vm-example-swap-join-points -->
    </div>
    <!-- vm-swap-join-points -->
  </div>
  <!-- vm-join-another -->

  <div class="subsubsection" id="vm-straight-line-reordering">
    <h4>Straight-line reordering ({reg, mem} &#8646; {reg, mem})</h4>

    <div class="paragraph" id="vm-move-reg-above-reg-or-mem">
      <h5>Move reg above reg or mem</h5>
      <div class="flex-container">
        <div class="width-half"><img src="{{ img_path }}/swap-reg-and-reg.svg"></div>
        <div class="width-half"><img src="{{ img_path }}/move-reg-above-mem.svg"></div>
      </div>

      <div class="example" id="vm-example-move-reg-above-mem">
        <h5>Move reg above mem</h5>
        <div class="flex-container">
          <div>
            <div class="code-title">Before reordering</div>
            <div>{% highlight c %}{{ move-reg-above-mem-before }}{% endhighlight %}</div>
          </div>
          <div>
            <div class="code-title">After reordering</div>
            <div>{% highlight c %}{{ move-reg-above-mem-after }}{% endhighlight %}</div>
          </div>
        </div>
      </div>
      <!-- vm-example-move-reg-above-mem -->
    </div>
    <!-- move-reg-above-reg-or-mem -->

    <div class="paragraph" id="vm-move-mem-above-reg-or-mem">
      <h5>Move mem above reg or mem</h5>
      <div class="flex-container">
        <div><img src="{{ img_path }}/move-mem-above-reg.svg"></div>
        <div><img src="{{ img_path }}/swap-mem-and-mem.svg"></div>
      </div>

      <div class="example" id="vm-example-move-mem-above-reg">
        <h5>Move mem above reg</h5>
        <div class="flex-container">
          <div>
            <div class="code-title">Before reordering</div>
            <div>{% highlight c %}{{ move-mem-above-reg-before }}{% endhighlight %}</div>
          </div>
          <div>
            <div class="code-title">After reordering</div>
            <div>{% highlight c %}{{ move-mem-above-reg-after }}{% endhighlight %}</div>
          </div>
        </div>

        <p>
          We assume that mem cannot be recoverable ("undone") before.<br />
          If
          <code>1: R1 = R2 + R3</code>
          will trap, we cannot recover the original state.
        </p>
      </div>
      <!-- vm-example-move-mem-above-reg -->
    </div>
    <!-- vm-move-mem-above-reg-or-mem -->
  </div>
  <!-- vm-straight-line-reordering -->

  <div class="subsubsection" id="vm-4-5-1-summary">
    <h4>Summary</h4>

    <table>
      <tr>
        <th></th>
        <th colspan="4">First (moved down)</th>
      </tr>
      <tr>
        <th>Second (moved up)</th>
        <th>reg</th>
        <th>mem</th>
        <th>br</th>
        <th>join</th>
      </tr>
      <tr>
        <th>reg</th>
        <td>{{ extend-live-range }}</td>
        <td>{{ extend-live-range }}</td>
        <td>{{ extend-live-range }}</td>
        <td>{{ comp-entrance }}</td>
      </tr>
      <tr>
        <th>mem</th>
        <td>{{ not-allowed }}</td>
        <td>{{ not-allowed }}</td>
        <td>{{ not-allowed }}</td>
        <td>{{ comp-entrance }}</td>
      </tr>
      <tr>
        <th>br</th>
        <td>{{ comp-exit }}</td>
        <td>{{ comp-exit }}</td>
        <td>{{ not-allowed-unless-cf }}</td>
        <td>{{ not-allowed-unless-cf }}</td>
      </tr>
      <tr>
        <th>join</th>
        <td>{{ not-allowed-unless-rare }}</td>
        <td>{{ not-allowed-unless-rare }}</td>
        <td>{{ not-allowed-unless-cf }}</td>
        <td>{{ no-effect }}</td>
      </tr>
    </table>

    <p>Possible reordering is the followings:</p>
    <ul>
      <li>
        Move
        <em>reg</em>
        above any instructions (using saved registers)
        <ul>
          <li>Register states can be recoverable.</li>
        </ul>
      </li>
      <li>
        Move
        <em>reg</em>
        or
        <em>mem</em>
        below
        <em>br</em>
        (by adding compensation code)
      </li>
      <li>
        Move
        <em>mem</em>
        above
        <em>join</em>
        (by adding compensation code)
      </li>
    </ul>
  </div>
  <!-- vm-4-5-1-summary -->

  <div class="question" id="question-4-5-1">
    <h5>Answer whether this optimization is allowed and why.</h5>

    <div class="flex-container">
      <div>
        <div class="code-title">Before reordering</div>
        <div>{% highlight c %}{{ question-4-5-1-q1-before }}{% endhighlight %}</div>
      </div>
      <div>
        <div class="code-title">After reordering</div>
        <div>{% highlight c %}{{ question-4-5-1-q1-after }}{% endhighlight %}</div>
      </div>
    </div>

    <details>
      <summary class="answer"></summary>
      No. A saved register is needed.
      <div class="flex-container">
        <div>{% highlight c %}{{ question-4-5-1-q1-answer }}{% endhighlight %}</div>
      </div>
    </details>

    <div class="flex-container">
      <div>
        <div class="code-title">Before reordering</div>
        <div>{% highlight c %}{{ question-4-5-1-q2-before }}{% endhighlight %}</div>
      </div>
      <div>
        <div class="code-title">After reordering</div>
        <div>{% highlight c %}{{ question-4-5-1-q2-after }}{% endhighlight %}</div>
      </div>
    </div>

    <details>
      <summary class="answer"></summary>
      No. If <code>r1 = r2 + r3</code> trap, we cannot recover <code>mem[r4]</code>.
    </details>
  </div>
  <!-- question-4-5-1 -->

</div>
<!-- vm-4-5-1-primitive-instruction-reordering -->
